<!-- Results Summary Chart Component -->
<div class="chart-container">
    <canvas id="summaryChart" width="360" height="288"></canvas>
</div>
<script>
function initializeSummaryChart() {
    const ctx = document.getElementById('summaryChart');
    if (!ctx) {
        setTimeout(initializeSummaryChart, 100);
        return;
    }
    
    if (typeof window.statusColors === 'undefined' || typeof window.add3DEffect === 'undefined' || typeof Chart === 'undefined') {
        setTimeout(initializeSummaryChart, 100);
        return;
    }
    
    // Extract status data from template
    const statusData = [
        {% for result in report_rows %}
        `{{ result.test_status|e }}`{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Calculate summary data from status
    const summaryData = [0, 0, 0]; // [Passed, Failed, Skipped]
    statusData.forEach(status => {
        if (status === 'PASSED') summaryData[0]++;
        else if (status === 'FAILED' || status === 'ERROR') summaryData[1]++;
        else if (status === 'SKIPPED') summaryData[2]++;
    });
    
    // Destroy existing chart instance if it exists
    const existingChart = Chart.getChart('summaryChart');
    if (existingChart) {
        existingChart.destroy();
    }
    
    const baseColors = [window.statusColors['PASSED'], window.statusColors['FAILED'], window.statusColors['SKIPPED']];
    new Chart(ctx.getContext('2d'), {
        type: 'pie',
        data: {
            labels: ['Passed', 'Failed', 'Skipped'],
            datasets: [{
                data: summaryData,
                backgroundColor: window.add3DEffect(ctx.getContext('2d'), 'pie', baseColors),
                borderWidth: 1
            }]
        },
        options: {
            responsive: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Results Summary',
                    font: { size: 16, weight: 'bold' },
                    color: '#212121',
                    padding: { top: 0, bottom: 12 }
                },
                legend: {
                    display: true,
                    position: 'right',
                    align: 'center',
                    labels: {
                        font: { size: 14 },
                        usePointStyle: true,
                        pointStyle: 'circle',
                        generateLabels: function(chart) {
                            const data = chart.data;
                            return data.labels.map((label, i) => {
                                return {
                                    text: label,
                                    fillStyle: baseColors[i],
                                    strokeStyle: baseColors[i],
                                    lineWidth: 1,
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                    }
                }
            }
        }
    });
}
(function() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeSummaryChart);
    } else {
        initializeSummaryChart();
    }
})();
</script>
