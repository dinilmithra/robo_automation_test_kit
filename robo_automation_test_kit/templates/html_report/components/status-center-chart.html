<!-- Status by Center Chart Component -->
<div class="chart-container">
    <canvas id="statusByCenterChart" width="360" height="288"></canvas>
</div>
<script>
function initializeStatusCenterChart() {
    const ctx = document.getElementById('statusByCenterChart');
    if (!ctx) {
        setTimeout(initializeStatusCenterChart, 100);
        return;
    }
    
    if (typeof window.statusColors === 'undefined' || typeof window.add3DEffect === 'undefined' || typeof Chart === 'undefined') {
        setTimeout(initializeStatusCenterChart, 100);
        return;
    }

    const centerStatusData = [
        {% for result in report_rows %}
        {
            center: `{{ result.Center|e }}`,
            status: `{{ result.test_status|e }}`
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    const statusTypes = window.statusTypes || ['PASSED', 'FAILED', 'SKIPPED'];
    const statusColors = window.statusColors;
    const add3DEffect = window.add3DEffect;

    const centerSet = new Set();
    centerStatusData.forEach(r => {
        if (r.center && r.center !== '-') centerSet.add(r.center);
    });
    const centerLabels = Array.from(centerSet);

    const statusByCenter = {};
    centerStatusData.forEach(r => {
        if (!r.center || r.center === '-') return;
        let status = (r.status || '').toUpperCase();
        if (status === 'ERROR') status = 'FAILED';
        if (!statusTypes.includes(status)) return;
        if (!statusByCenter[r.center]) statusByCenter[r.center] = { PASSED: 0, FAILED: 0, SKIPPED: 0 };
        if (statusByCenter[r.center][status] !== undefined) statusByCenter[r.center][status]++;
        if (statusByCenter[r.center][status] !== undefined) statusByCenter[r.center][status]++;
    });

    const barDatasets = statusTypes.map(st => ({
        label: st.charAt(0) + st.slice(1).toLowerCase(),
        data: centerLabels.map(c => (statusByCenter[c] ? statusByCenter[c][st] : 0)),
        backgroundColor: statusColors[st],
        borderWidth: 1
    }));
    
    const ctxObj = ctx.getContext('2d');
    const bar3dDatasets = barDatasets.map(ds => ({
        ...ds,
        backgroundColor: add3DEffect(ctxObj, 'bar', [statusColors[ds.label.toUpperCase()]])
    }));
    
    // Destroy existing chart instance if it exists
    const existingChart = Chart.getChart('statusByCenterChart');
    if (existingChart) {
        existingChart.destroy();
    }
    
    new Chart(ctxObj, {
        type: 'bar',
        data: {
            labels: centerLabels,
            datasets: bar3dDatasets
        },
        options: {
            indexAxis: 'y',
            responsive: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'center',
                    margin: 0,
                    labels: {
                        font: { size: 10 },
                        usePointStyle: true,
                        boxHeight: 12,
                        pointStyle: 'rect',
                        generateLabels: function(chart) {
                            return chart.data.datasets.map((ds, i) => {
                                const label = ds.label;
                                const color = statusColors[label.toUpperCase()] || '#888';
                                return {
                                    text: label,
                                    fillStyle: color,
                                    strokeStyle: color,
                                    lineWidth: 1,
                                    pointStyle: 'rect',
                                    hidden: false,
                                    index: i
                                };
                            });
                        }
                    }
                },
                title: { display: true, text: 'Status by Center', font: { size: 18 }, padding: { top: 0, bottom: 4 } }
            },
            scales: {
                x: {
                    stacked: true,
                    title: {
                        display: true,
                        text: 'Test Cases',
                        font: { size: 12, weight: 'bold' },
                        color: '#212121'
                    },
                    ticks: {
                        font: { size: 10, weight: 'bold' },
                        color: '#212121',
                        stepSize: 1,
                        callback: function(value) {
                            if (Number.isInteger(value)) return value;
                            return '';
                        }
                    }
                },
                y: {
                    stacked: true,
                    title: { display: false },
                    ticks: {
                        font: { size: 10, weight: 'bold' },
                        color: '#212121',
                        stepSize: 1,
                        callback: function(value, index) {
                            return centerLabels && centerLabels[index] ? centerLabels[index] : value;
                        }
                    }
                }
            }
        }
    });
}
(function() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeStatusCenterChart);
    } else {
        initializeStatusCenterChart();
    }
})();
</script>
